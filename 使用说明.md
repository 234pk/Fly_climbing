# Fly Climbing 多管子实验视频分析器

## 简介

Fly Climbing 是一个用于分析果蝇在多管子实验中爬行行为的视频分析工具。它可以自动检测多个管子中的果蝇位置，计算爬行高度，并比较不同基因型果蝇的爬行能力。

## 功能特点

- 支持多管子同时检测（最多10个管子）
- 自动检测管子区域
- 实时检测果蝇位置和爬行高度
- 比较不同基因型果蝇的爬行能力
- 导出检测数据为JSON格式
- 可视化显示检测结果

## 安装说明

### 环境要求

- Python 3.7+
- OpenCV 4.x
- PyQt5
- NumPy

### 安装步骤

1. 克隆或下载项目代码
2. 安装依赖包：

```bash
pip install -r requirements.txt
```

## 使用方法

### 启动程序

```bash
python main.py
```

### 基本操作流程

1. **加载视频**
   - 点击"打开视频"按钮，选择要分析的视频文件
   - 支持常见视频格式：AVI、MP4、MOV、MKV

2. **设置背景帧**
   - 播放视频到没有果蝇的帧
   - 点击"设置背景帧"按钮，将当前帧设为背景

3. **设置管子区域**
   - 在"管子设置"选项卡中设置管子数量
   - 点击"自动检测管子"按钮自动检测管子区域
   - 或手动设置每个管子的区域

4. **设置基因型**
   - 在管子信息表格中点击"设置基因型"按钮
   - 输入每个管子对应的果蝇基因型名称

5. **调整检测参数**
   - 在"检测参数"选项卡中调整检测参数：
     - 背景减法阈值：用于区分前景和背景
     - 最小果蝇面积：检测果蝇的最小像素面积
     - 最大果蝇面积：检测果蝇的最大像素面积

6. **开始检测**
   - 点击"开始检测"按钮开始实时检测
   - 播放视频，程序会自动检测每个管子中的果蝇
   - 检测结果会显示在"检测结果"选项卡中

7. **导出数据**
   - 点击"导出数据"按钮，将检测结果导出为JSON文件

### 高级功能

#### 手动设置管子区域

如果自动检测效果不佳，可以手动设置管子区域：

1. 暂停视频到包含管子的帧
2. 记录每个管子的区域坐标（x, y, width, height）
3. 在代码中调用 `set_tube_region` 方法设置区域

#### 调整检测参数

根据视频质量调整检测参数：

- **背景减法阈值**：视频噪声较大时增加阈值
- **最小/最大果蝇面积**：根据果蝇在图像中的大小调整

## 项目结构

```
Fly_climbing/
├── main.py                     # 主程序入口
├── requirements.txt            # 依赖包列表
├── README.md                   # 项目说明
├── video_player/               # 视频播放和检测模块
│   ├── __init__.py
│   ├── player.py               # 视频播放器
│   ├── multi_tube_detector.py  # 多管子果蝇检测器
│   └── multi_tube_ui.py        # 用户界面
└── tests/                      # 测试模块
    ├── __init__.py
    ├── test_player.py          # 视频播放器测试
    ├── test_multi_tube_detector.py  # 检测器测试
    └── run_tests.py            # 测试运行脚本
```

## API 文档

### MultiTubeFlyDetector 类

多管子果蝇检测器的主要类。

#### 初始化

```python
detector = MultiTubeFlyDetector(tube_count=5)
```

#### 主要方法

- `set_tube_count(count)`: 设置管子数量
- `set_tube_region(index, region)`: 设置管子区域
- `set_genotype_name(index, name)`: 设置基因型名称
- `set_background(frame)`: 设置背景帧
- `set_threshold(threshold)`: 设置背景减法阈值
- `detect_all_tubes(frame)`: 检测所有管子中的果蝇
- `get_fly_position(index)`: 获取指定管子的果蝇位置
- `get_climbing_height(index)`: 获取指定管子的果蝇爬行高度
- `compare_genotypes()`: 比较不同基因型的爬行能力
- `draw_detections(frame)`: 在图像上绘制检测结果
- `export_data()`: 导出检测数据
- `reset_data()`: 重置检测数据

### VideoPlayer 类

视频播放器的主要类。

#### 初始化

```python
player = VideoPlayer()
```

#### 主要方法

- `load_video(path)`: 加载视频文件
- `play()`: 播放视频
- `pause()`: 暂停视频
- `stop()`: 停止视频
- `next_frame()`: 播放下一帧
- `previous_frame()`: 播放上一帧
- `seek_frame(frame_number)`: 跳转到指定帧
- `get_current_frame()`: 获取当前帧
- `get_current_frame_number()`: 获取当前帧号
- `get_total_frames()`: 获取总帧数
- `get_fps()`: 获取视频帧率
- `set_playback_speed(speed)`: 设置播放速度

## 测试

运行所有测试：

```bash
python tests/run_tests.py
```

运行特定测试：

```bash
python -m unittest tests.test_multi_tube_detector
python -m unittest tests.test_player
```

## 常见问题

### 1. 检测效果不佳

- 调整背景减法阈值
- 调整最小/最大果蝇面积
- 确保背景帧中没有果蝇
- 确保管子区域设置正确

### 2. 自动检测管子失败

- 手动设置管子区域
- 确保管子在图像中对比度明显
- 调整管子数量设置

### 3. 程序启动失败

- 检查是否安装了所有依赖包
- 确保Python版本为3.7+
- 检查OpenCV是否正确安装

## 贡献指南

欢迎提交问题和改进建议！

1. Fork 项目
2. 创建特性分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证。

## 联系方式

如有问题或建议，请通过以下方式联系：

- 邮箱：fly_climbing@example.com
- 项目主页：https://github.com/example/fly_climbing